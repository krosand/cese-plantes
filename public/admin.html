<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Administration - Adopte une Plante</title>
  <!-- Bootstrap 5 CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: #f5f5f5;
    }
    .sidebar {
      min-height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
    }
    .sidebar .nav-link {
      color: rgba(255,255,255,0.8);
      transition: all 0.3s;
      border-radius: 8px;
      margin-bottom: 5px;
    }
    .sidebar .nav-link:hover,
    .sidebar .nav-link.active {
      color: white;
      background: rgba(255,255,255,0.2);
    }
    .content {
      padding: 30px;
    }
    .section {
      display: none;
    }
    .section.active {
      display: block;
    }
    .json-editor {
      font-family: 'Courier New', monospace;
      font-size: 14px;
      min-height: 400px;
    }
    .action-card {
      transition: transform 0.2s;
      cursor: pointer;
      border-left: 4px solid;
    }
    .action-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .success-message {
      display: none;
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
    }
  </style>
</head>
<body>
  <!-- Message de succès -->
  <div id="successMessage" class="alert alert-success success-message shadow-lg">
    <strong>✅ Succès !</strong> <span id="successText"></span>
  </div>

  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-md-3 col-lg-2 sidebar">
        <h4 class="text-white mb-4">⚙️ Admin Panel</h4>

        <nav class="nav flex-column">
          <a class="nav-link active" href="#" data-section="overview">
            📊 Vue d'ensemble
          </a>
          <a class="nav-link" href="#" data-section="questions">
            ❓ Questions
          </a>
          <a class="nav-link" href="#" data-section="plants">
            🌿 Plantes
          </a>
          <a class="nav-link" href="#" data-section="seed">
            🎲 Générer données
          </a>
          <a class="nav-link" href="#" data-section="export">
            📥 Export résultats
          </a>
        </nav>

        <hr class="bg-white my-4">

        <div class="mt-auto">
          <a href="/" class="btn btn-light btn-sm w-100 mb-2">🏠 Accueil</a>
          <a href="/stats.html" class="btn btn-outline-light btn-sm w-100">📊 Stats</a>
        </div>
      </div>

      <!-- Content -->
      <div class="col-md-9 col-lg-10 content">
        <!-- Overview Section -->
        <div id="overview" class="section active">
          <h2 class="mb-4">📊 Vue d'ensemble</h2>

          <div class="row g-4">
            <div class="col-md-6">
              <div class="card action-card shadow-sm" style="border-color: #4caf50;" data-goto="questions">
                <div class="card-body">
                  <h5 class="card-title">❓ Gérer les Questions</h5>
                  <p class="card-text text-muted">
                    Modifiez les questions du quiz, ajoutez des choix ou modifiez les pondérations.
                  </p>
                  <span class="badge bg-success" id="questionsCount">0 questions</span>
                </div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card action-card shadow-sm" style="border-color: #2196f3;" data-goto="plants">
                <div class="card-body">
                  <h5 class="card-title">🌿 Gérer les Plantes</h5>
                  <p class="card-text text-muted">
                    Ajoutez ou modifiez les fiches plantes et leurs recommandations.
                  </p>
                  <span class="badge bg-primary" id="plantsCount">0 plantes</span>
                </div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card action-card shadow-sm" style="border-color: #ff9800;" data-goto="seed">
                <div class="card-body">
                  <h5 class="card-title">🎲 Générer Données Simulées</h5>
                  <p class="card-text text-muted">
                    Créez des réponses aléatoires pour tester les statistiques.
                  </p>
                  <button class="btn btn-warning btn-sm">Générer</button>
                </div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card action-card shadow-sm" style="border-color: #9c27b0;" data-goto="export">
                <div class="card-body">
                  <h5 class="card-title">📥 Exporter Résultats</h5>
                  <p class="card-text text-muted">
                    Téléchargez tous les résultats au format CSV ou NDJSON.
                  </p>
                  <button class="btn btn-purple btn-sm">Exporter</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Questions Section -->
        <div id="questions" class="section">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>❓ Gestion des Questions</h2>
            <button class="btn btn-success" id="saveQuestionsBtn">💾 Sauvegarder</button>
          </div>

          <div class="alert alert-info">
            <strong>ℹ️ Format JSON :</strong> Modifiez le JSON ci-dessous. Assurez-vous que la syntaxe est valide avant de sauvegarder.
          </div>

          <textarea id="questionsEditor" class="form-control json-editor"></textarea>

          <div class="mt-3">
            <button class="btn btn-outline-secondary" id="resetQuestionsBtn">🔄 Annuler modifications</button>
          </div>
        </div>

        <!-- Plants Section -->
        <div id="plants" class="section">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>🌿 Gestion des Plantes</h2>
            <button class="btn btn-success" id="savePlantsBtn">💾 Sauvegarder</button>
          </div>

          <div class="alert alert-info">
            <strong>ℹ️ Format JSON :</strong> Modifiez les fiches plantes par famille. Respectez la structure existante.
          </div>

          <textarea id="plantsEditor" class="form-control json-editor"></textarea>

          <div class="mt-3">
            <button class="btn btn-outline-secondary" id="resetPlantsBtn">🔄 Annuler modifications</button>
          </div>
        </div>

        <!-- Seed Section -->
        <div id="seed" class="section">
          <h2 class="mb-4">🎲 Générer Données Simulées</h2>

          <div class="card shadow-sm">
            <div class="card-body">
              <h5 class="card-title">Créer des réponses aléatoires</h5>
              <p class="text-muted">
                Générez des soumissions de test pour remplir vos statistiques.
                Utile pour tester l'interface sans faire le quiz manuellement.
              </p>

              <div class="mb-3">
                <label for="seedCount" class="form-label">Nombre de réponses à générer</label>
                <input type="number" class="form-control" id="seedCount" value="50" min="1" max="1000">
              </div>

              <button class="btn btn-warning btn-lg" id="generateSeedBtn">
                🎲 Générer les données
              </button>
            </div>
          </div>

          <div id="seedResult" class="mt-4"></div>
        </div>

        <!-- Export Section -->
        <div id="export" class="section">
          <h2 class="mb-4">📥 Export des Résultats</h2>

          <div class="row g-4">
            <div class="col-md-6">
              <div class="card shadow-sm">
                <div class="card-body">
                  <h5 class="card-title">📄 Export CSV</h5>
                  <p class="card-text text-muted">
                    Téléchargez tous les résultats au format CSV pour Excel ou Google Sheets.
                  </p>
                  <a href="/api/admin/export?format=csv" class="btn btn-primary" download>
                    📥 Télécharger CSV
                  </a>
                </div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card shadow-sm">
                <div class="card-body">
                  <h5 class="card-title">📋 Export NDJSON</h5>
                  <p class="card-text text-muted">
                    Téléchargez le fichier NDJSON brut pour traitement personnalisé.
                  </p>
                  <a href="/api/admin/export?format=ndjson" class="btn btn-secondary" download>
                    📥 Télécharger NDJSON
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    let questionsData = [];
    let plantsData = {};

    // Navigation entre sections
    document.querySelectorAll('.nav-link').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        const sectionId = this.dataset.section;
        showSection(sectionId);

        // Mettre à jour active state
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        this.classList.add('active');
      });
    });

    // Navigation depuis cards overview
    document.querySelectorAll('.action-card').forEach(card => {
      card.addEventListener('click', function() {
        const goto = this.dataset.goto;
        if (goto) {
          showSection(goto);
          document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
          document.querySelector(`[data-section="${goto}"]`).classList.add('active');
        }
      });
    });

    function showSection(sectionId) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById(sectionId).classList.add('active');
    }

    // Afficher message succès
    function showSuccess(message) {
      const msgEl = document.getElementById('successMessage');
      document.getElementById('successText').textContent = message;
      msgEl.style.display = 'block';
      setTimeout(() => {
        msgEl.style.display = 'none';
      }, 3000);
    }

    // Charger questions
    async function loadQuestions() {
      try {
        const response = await fetch('/api/admin/questions');
        questionsData = await response.json();
        document.getElementById('questionsEditor').value = JSON.stringify(questionsData, null, 2);
        document.getElementById('questionsCount').textContent = questionsData.length + ' questions';
      } catch (err) {
        console.error('Erreur chargement questions:', err);
      }
    }

    // Sauvegarder questions
    document.getElementById('saveQuestionsBtn').addEventListener('click', async () => {
      try {
        const content = document.getElementById('questionsEditor').value;
        const questions = JSON.parse(content);

        const response = await fetch('/api/admin/questions', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ questions })
        });

        const result = await response.json();
        if (result.success) {
          showSuccess('Questions sauvegardées avec succès');
          loadQuestions();
        }
      } catch (err) {
        alert('Erreur : JSON invalide ou erreur serveur\n' + err.message);
      }
    });

    // Reset questions
    document.getElementById('resetQuestionsBtn').addEventListener('click', () => {
      document.getElementById('questionsEditor').value = JSON.stringify(questionsData, null, 2);
    });

    // Charger plantes
    async function loadPlants() {
      try {
        const response = await fetch('/api/admin/plants');
        plantsData = await response.json();
        document.getElementById('plantsEditor').value = JSON.stringify(plantsData, null, 2);

        const total = Object.values(plantsData).reduce((sum, arr) => sum + arr.length, 0);
        document.getElementById('plantsCount').textContent = total + ' plantes';
      } catch (err) {
        console.error('Erreur chargement plantes:', err);
      }
    }

    // Sauvegarder plantes
    document.getElementById('savePlantsBtn').addEventListener('click', async () => {
      try {
        const content = document.getElementById('plantsEditor').value;
        const plants = JSON.parse(content);

        const response = await fetch('/api/admin/plants', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ plants })
        });

        const result = await response.json();
        if (result.success) {
          showSuccess('Plantes sauvegardées avec succès');
          loadPlants();
        }
      } catch (err) {
        alert('Erreur : JSON invalide ou erreur serveur\n' + err.message);
      }
    });

    // Reset plantes
    document.getElementById('resetPlantsBtn').addEventListener('click', () => {
      document.getElementById('plantsEditor').value = JSON.stringify(plantsData, null, 2);
    });

    // Générer données
    document.getElementById('generateSeedBtn').addEventListener('click', async () => {
      const count = parseInt(document.getElementById('seedCount').value);

      if (count < 1 || count > 1000) {
        alert('Nombre invalide (1-1000)');
        return;
      }

      const btn = document.getElementById('generateSeedBtn');
      btn.disabled = true;
      btn.textContent = '⏳ Génération...';

      try {
        const response = await fetch('/api/admin/seed', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ count })
        });

        const result = await response.json();

        document.getElementById('seedResult').innerHTML = `
          <div class="alert alert-success">
            <strong>✅ ${result.message}</strong>
            <p class="mb-0 mt-2">Vous pouvez maintenant consulter les statistiques mises à jour.</p>
          </div>
        `;

        showSuccess(result.message);
      } catch (err) {
        alert('Erreur lors de la génération');
        console.error(err);
      } finally {
        btn.disabled = false;
        btn.textContent = '🎲 Générer les données';
      }
    });

    // Initialisation
    loadQuestions();
    loadPlants();
  </script>
</body>
</html>
