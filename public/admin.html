<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="POC PLANTE MERYEM">
  <meta name="description" content="Interface d'administration - POC PLANTE MERYEM">
  <title>Administration - Adopte une Plante</title>
  <!-- Bootstrap 5 CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: #f5f5f5;
    }
    .sidebar {
      min-height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
    }
    .sidebar .nav-link {
      color: rgba(255,255,255,0.8);
      transition: all 0.3s;
      border-radius: 8px;
      margin-bottom: 5px;
    }
    .sidebar .nav-link:hover,
    .sidebar .nav-link.active {
      color: white;
      background: rgba(255,255,255,0.2);
    }
    .content {
      padding: 30px;
    }
    .section {
      display: none;
    }
    .section.active {
      display: block;
    }
    .json-editor {
      font-family: 'Courier New', monospace;
      font-size: 14px;
      min-height: 400px;
    }
    .action-card {
      transition: transform 0.2s;
      cursor: pointer;
      border-left: 4px solid;
    }
    .action-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .success-message {
      display: none;
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
    }
  </style>
</head>
<body>
  <!-- Message de succÃ¨s -->
  <div id="successMessage" class="alert alert-success success-message shadow-lg">
    <strong>âœ… SuccÃ¨s !</strong> <span id="successText"></span>
  </div>

  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-md-3 col-lg-2 sidebar">
        <img src="logo-cese.svg" alt="Logo CESE" style="height: 50px; margin-bottom: 20px; filter: brightness(0) invert(1);">
        <h4 class="text-white mb-4">âš™ï¸ Admin Panel</h4>

        <nav class="nav flex-column">
          <a class="nav-link active" href="#" data-section="overview">
            ğŸ“Š Vue d'ensemble
          </a>
          <a class="nav-link" href="#" data-section="questions">
            â“ Questions
          </a>
          <a class="nav-link" href="#" data-section="plants">
            ğŸŒ¿ Plantes
          </a>
          <a class="nav-link" href="#" data-section="seed">
            ğŸ² GÃ©nÃ©rer donnÃ©es
          </a>
          <a class="nav-link" href="#" data-section="export">
            ğŸ“¥ Export rÃ©sultats
          </a>
        </nav>

        <hr class="bg-white my-4">

        <div class="mt-auto">
          <a href="index.html" class="btn btn-light btn-sm w-100 mb-2">ğŸ  Accueil</a>
          <a href="stats.html" class="btn btn-outline-light btn-sm w-100">ğŸ“Š Stats</a>
        </div>
      </div>

      <!-- Content -->
      <div class="col-md-9 col-lg-10 content">
        <!-- Overview Section -->
        <div id="overview" class="section active">
          <h2 class="mb-4">ğŸ“Š Vue d'ensemble</h2>

          <div class="row g-4">
            <div class="col-md-6">
              <div class="card action-card shadow-sm" style="border-color: #4caf50;" data-goto="questions">
                <div class="card-body">
                  <h5 class="card-title">â“ GÃ©rer les Questions</h5>
                  <p class="card-text text-muted">
                    Modifiez les questions du quiz, ajoutez des choix ou modifiez les pondÃ©rations.
                  </p>
                  <span class="badge bg-success" id="questionsCount">0 questions</span>
                </div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card action-card shadow-sm" style="border-color: #2196f3;" data-goto="plants">
                <div class="card-body">
                  <h5 class="card-title">ğŸŒ¿ GÃ©rer les Plantes</h5>
                  <p class="card-text text-muted">
                    Ajoutez ou modifiez les fiches plantes et leurs recommandations.
                  </p>
                  <span class="badge bg-primary" id="plantsCount">0 plantes</span>
                </div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card action-card shadow-sm" style="border-color: #ff9800;" data-goto="seed">
                <div class="card-body">
                  <h5 class="card-title">ğŸ² GÃ©nÃ©rer DonnÃ©es SimulÃ©es</h5>
                  <p class="card-text text-muted">
                    CrÃ©ez des rÃ©ponses alÃ©atoires pour tester les statistiques.
                  </p>
                  <button class="btn btn-warning btn-sm">GÃ©nÃ©rer</button>
                </div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card action-card shadow-sm" style="border-color: #9c27b0;" data-goto="export">
                <div class="card-body">
                  <h5 class="card-title">ğŸ“¥ Exporter RÃ©sultats</h5>
                  <p class="card-text text-muted">
                    TÃ©lÃ©chargez tous les rÃ©sultats au format CSV ou NDJSON.
                  </p>
                  <button class="btn btn-purple btn-sm">Exporter</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Questions Section -->
        <div id="questions" class="section">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>â“ Gestion des Questions</h2>
            <div>
              <button class="btn btn-outline-secondary me-2" id="toggleQuestionViewBtn">
                <span id="questionViewModeIcon">ğŸ“</span> <span id="questionViewModeText">Mode JSON</span>
              </button>
              <button class="btn btn-success" id="saveQuestionsBtn">ğŸ’¾ Sauvegarder</button>
            </div>
          </div>

          <!-- Interface conviviale (par dÃ©faut) -->
          <div id="questionsFriendlyView">
            <div class="alert alert-success">
              <strong>âœ¨ Interface simple :</strong> Modifiez les questions et rÃ©ponses facilement. Pas besoin de connaÃ®tre le JSON !
            </div>

            <!-- Liste des questions -->
            <div id="questionsListContainer"></div>

            <button class="btn btn-outline-primary mt-3" id="addQuestionBtn">
              â• Ajouter une question
            </button>
          </div>

          <!-- Vue JSON (cachÃ©e par dÃ©faut) -->
          <div id="questionsJsonView" style="display: none;">
            <div class="alert alert-warning">
              <strong>âš ï¸ Mode expert :</strong> Modifiez le JSON directement. Attention Ã  la syntaxe !
            </div>
            <textarea id="questionsEditor" class="form-control json-editor"></textarea>
          </div>

          <div class="mt-3">
            <button class="btn btn-outline-secondary" id="resetQuestionsBtn">ğŸ”„ Annuler modifications</button>
          </div>
        </div>

        <!-- Plants Section -->
        <div id="plants" class="section">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>ğŸŒ¿ Gestion des Plantes</h2>
            <div>
              <button class="btn btn-outline-secondary me-2" id="togglePlantViewBtn">
                <span id="viewModeIcon">ğŸ“</span> <span id="viewModeText">Mode JSON</span>
              </button>
              <button class="btn btn-success" id="savePlantsBtn">ğŸ’¾ Sauvegarder</button>
            </div>
          </div>

          <!-- Interface conviviale (par dÃ©faut) -->
          <div id="plantsFriendlyView">
            <div class="alert alert-success">
              <strong>âœ¨ Interface simple :</strong> Modifiez les plantes en remplissant les champs ci-dessous. Pas besoin de connaÃ®tre le JSON !
            </div>

            <!-- SÃ©lecteur de famille -->
            <div class="mb-4">
              <label class="form-label fw-bold">Famille de plantes :</label>
              <select class="form-select" id="plantFamilySelect">
                <option value="DÃ©polluante">ğŸŒ¿ DÃ©polluante</option>
                <option value="Grimpante">ğŸŒ´ Grimpante</option>
                <option value="Exotique">ğŸŒ¸ Exotique</option>
                <option value="RÃ©sistante">ğŸŒµ RÃ©sistante</option>
              </select>
            </div>

            <!-- Liste des plantes de la famille sÃ©lectionnÃ©e -->
            <div id="plantsListContainer"></div>

            <button class="btn btn-outline-primary mt-3" id="addPlantBtn">
              â• Ajouter une plante Ã  cette famille
            </button>
          </div>

          <!-- Vue JSON (cachÃ©e par dÃ©faut) -->
          <div id="plantsJsonView" style="display: none;">
            <div class="alert alert-warning">
              <strong>âš ï¸ Mode expert :</strong> Modifiez le JSON directement. Attention Ã  la syntaxe !
            </div>
            <textarea id="plantsEditor" class="form-control json-editor"></textarea>
          </div>

          <div class="mt-3">
            <button class="btn btn-outline-secondary" id="resetPlantsBtn">ğŸ”„ Annuler modifications</button>
          </div>
        </div>

        <!-- Seed Section -->
        <div id="seed" class="section">
          <h2 class="mb-4">ğŸ² GÃ©nÃ©rer DonnÃ©es SimulÃ©es</h2>

          <div class="card shadow-sm">
            <div class="card-body">
              <h5 class="card-title">CrÃ©er des rÃ©ponses alÃ©atoires</h5>
              <p class="text-muted">
                GÃ©nÃ©rez des soumissions de test pour remplir vos statistiques.
                Utile pour tester l'interface sans faire le quiz manuellement.
              </p>

              <div class="mb-3">
                <label for="seedCount" class="form-label">Nombre de rÃ©ponses Ã  gÃ©nÃ©rer</label>
                <input type="number" class="form-control" id="seedCount" value="50" min="1" max="1000">
              </div>

              <button class="btn btn-warning btn-lg" id="generateSeedBtn">
                ğŸ² GÃ©nÃ©rer les donnÃ©es
              </button>
            </div>
          </div>

          <div id="seedResult" class="mt-4"></div>
        </div>

        <!-- Export Section -->
        <div id="export" class="section">
          <h2 class="mb-4">ğŸ“¥ Export des RÃ©sultats</h2>

          <div class="row g-4">
            <div class="col-md-6">
              <div class="card shadow-sm">
                <div class="card-body">
                  <h5 class="card-title">ğŸ“„ Export CSV</h5>
                  <p class="card-text text-muted">
                    TÃ©lÃ©chargez tous les rÃ©sultats au format CSV pour Excel ou Google Sheets.
                  </p>
                  <a href="/api/admin/export?format=csv" class="btn btn-primary" download>
                    ğŸ“¥ TÃ©lÃ©charger CSV
                  </a>
                </div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card shadow-sm">
                <div class="card-body">
                  <h5 class="card-title">ğŸ“‹ Export NDJSON</h5>
                  <p class="card-text text-muted">
                    TÃ©lÃ©chargez le fichier NDJSON brut pour traitement personnalisÃ©.
                  </p>
                  <a href="/api/admin/export?format=ndjson" class="btn btn-secondary" download>
                    ğŸ“¥ TÃ©lÃ©charger NDJSON
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Config -->
  <script src="config.js"></script>

  <script>
    let questionsData = [];
    let plantsData = {};

    // Navigation entre sections
    document.querySelectorAll('.nav-link').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        const sectionId = this.dataset.section;
        showSection(sectionId);

        // Mettre Ã  jour active state
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        this.classList.add('active');
      });
    });

    // Navigation depuis cards overview
    document.querySelectorAll('.action-card').forEach(card => {
      card.addEventListener('click', function() {
        const goto = this.dataset.goto;
        if (goto) {
          showSection(goto);
          document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
          document.querySelector(`[data-section="${goto}"]`).classList.add('active');
        }
      });
    });

    function showSection(sectionId) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById(sectionId).classList.add('active');
    }

    // Afficher message succÃ¨s
    function showSuccess(message) {
      const msgEl = document.getElementById('successMessage');
      document.getElementById('successText').textContent = message;
      msgEl.style.display = 'block';
      setTimeout(() => {
        msgEl.style.display = 'none';
      }, 3000);
    }

    // Variables pour mode questions
    let questionViewMode = 'friendly'; // ou 'json'

    // Charger questions
    async function loadQuestions() {
      try {
        questionsData = await apiCall('/api/admin/questions');
        document.getElementById('questionsEditor').value = JSON.stringify(questionsData, null, 2);
        document.getElementById('questionsCount').textContent = questionsData.length + ' questions';

        // Charger la vue conviviale
        renderQuestionsList();
      } catch (err) {
        console.error('Erreur chargement questions:', err);
      }
    }

    // Rendre la liste des questions en mode convivial
    function renderQuestionsList() {
      const container = document.getElementById('questionsListContainer');
      container.innerHTML = '';

      questionsData.forEach((question, qIdx) => {
        const card = document.createElement('div');
        card.className = 'card mb-4';
        card.innerHTML = `
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="card-title mb-0">Question ${qIdx + 1}</h5>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteQuestion(${qIdx})">ğŸ—‘ï¸ Supprimer</button>
            </div>

            <div class="mb-3">
              <label class="form-label fw-bold">Texte de la question</label>
              <input type="text" class="form-control" value="${question.text}"
                     onchange="updateQuestionText(${qIdx}, this.value)">
            </div>

            <div class="mb-3">
              <label class="form-label fw-bold">RÃ©ponses (choix)</label>
              <div id="choices-${qIdx}">
                ${question.choices.map((choice, cIdx) => `
                  <div class="card mb-2">
                    <div class="card-body">
                      <div class="d-flex justify-content-between align-items-center mb-2">
                        <strong>Choix ${cIdx + 1}</strong>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteChoice(${qIdx}, ${cIdx})">ğŸ—‘ï¸</button>
                      </div>

                      <div class="mb-2">
                        <label class="form-label">Texte du choix</label>
                        <input type="text" class="form-control" value="${choice.label}"
                               onchange="updateChoiceLabel(${qIdx}, ${cIdx}, this.value)">
                      </div>

                      <div class="row g-2">
                        <div class="col-6">
                          <label class="form-label">ğŸŒ¿ DÃ©polluante</label>
                          <input type="number" class="form-control" value="${choice.scores['DÃ©polluante']}"
                                 onchange="updateChoiceScore(${qIdx}, ${cIdx}, 'DÃ©polluante', parseInt(this.value))">
                        </div>
                        <div class="col-6">
                          <label class="form-label">ğŸŒ´ Grimpante</label>
                          <input type="number" class="form-control" value="${choice.scores['Grimpante']}"
                                 onchange="updateChoiceScore(${qIdx}, ${cIdx}, 'Grimpante', parseInt(this.value))">
                        </div>
                        <div class="col-6">
                          <label class="form-label">ğŸŒ¸ Exotique</label>
                          <input type="number" class="form-control" value="${choice.scores['Exotique']}"
                                 onchange="updateChoiceScore(${qIdx}, ${cIdx}, 'Exotique', parseInt(this.value))">
                        </div>
                        <div class="col-6">
                          <label class="form-label">ğŸŒµ RÃ©sistante</label>
                          <input type="number" class="form-control" value="${choice.scores['RÃ©sistante']}"
                                 onchange="updateChoiceScore(${qIdx}, ${cIdx}, 'RÃ©sistante', parseInt(this.value))">
                        </div>
                      </div>
                    </div>
                  </div>
                `).join('')}
              </div>
              <button class="btn btn-sm btn-outline-primary mt-2" onclick="addChoice(${qIdx})">
                â• Ajouter un choix
              </button>
            </div>
          </div>
        `;
        container.appendChild(card);
      });
    }

    // Mettre Ã  jour le texte d'une question
    function updateQuestionText(qIdx, value) {
      questionsData[qIdx].text = value;
      syncQuestionsJsonEditor();
    }

    // Mettre Ã  jour le label d'un choix
    function updateChoiceLabel(qIdx, cIdx, value) {
      questionsData[qIdx].choices[cIdx].label = value;
      syncQuestionsJsonEditor();
    }

    // Mettre Ã  jour le score d'un choix
    function updateChoiceScore(qIdx, cIdx, family, value) {
      questionsData[qIdx].choices[cIdx].scores[family] = value;
      syncQuestionsJsonEditor();
    }

    // Supprimer une question
    function deleteQuestion(qIdx) {
      if (confirm('ÃŠtes-vous sÃ»r de vouloir supprimer cette question ?')) {
        questionsData.splice(qIdx, 1);
        renderQuestionsList();
        syncQuestionsJsonEditor();
      }
    }

    // Supprimer un choix
    function deleteChoice(qIdx, cIdx) {
      if (questionsData[qIdx].choices.length <= 2) {
        alert('Une question doit avoir au moins 2 choix');
        return;
      }
      if (confirm('ÃŠtes-vous sÃ»r de vouloir supprimer ce choix ?')) {
        questionsData[qIdx].choices.splice(cIdx, 1);
        renderQuestionsList();
        syncQuestionsJsonEditor();
      }
    }

    // Ajouter un choix Ã  une question
    function addChoice(qIdx) {
      const newChoice = {
        label: "Nouveau choix",
        scores: {
          "DÃ©polluante": 0,
          "Grimpante": 0,
          "Exotique": 0,
          "RÃ©sistante": 0
        }
      };
      questionsData[qIdx].choices.push(newChoice);
      renderQuestionsList();
      syncQuestionsJsonEditor();
    }

    // Ajouter une question
    document.getElementById('addQuestionBtn').addEventListener('click', () => {
      const newQuestion = {
        id: questionsData.length + 1,
        text: "Nouvelle question",
        choices: [
          {
            label: "Choix 1",
            scores: { "DÃ©polluante": 3, "Grimpante": 1, "Exotique": 0, "RÃ©sistante": 2 }
          },
          {
            label: "Choix 2",
            scores: { "DÃ©polluante": 0, "Grimpante": 3, "Exotique": 2, "RÃ©sistante": 1 }
          }
        ]
      };
      questionsData.push(newQuestion);
      renderQuestionsList();
      syncQuestionsJsonEditor();
    });

    // Synchroniser l'Ã©diteur JSON questions
    function syncQuestionsJsonEditor() {
      document.getElementById('questionsEditor').value = JSON.stringify(questionsData, null, 2);
    }

    // Basculer entre mode convivial et JSON pour questions
    document.getElementById('toggleQuestionViewBtn').addEventListener('click', () => {
      const friendlyView = document.getElementById('questionsFriendlyView');
      const jsonView = document.getElementById('questionsJsonView');
      const icon = document.getElementById('questionViewModeIcon');
      const text = document.getElementById('questionViewModeText');

      if (questionViewMode === 'friendly') {
        questionViewMode = 'json';
        friendlyView.style.display = 'none';
        jsonView.style.display = 'block';
        icon.textContent = 'ğŸ“';
        text.textContent = 'Mode Simple';
      } else {
        questionViewMode = 'friendly';
        try {
          questionsData = JSON.parse(document.getElementById('questionsEditor').value);
          renderQuestionsList();
        } catch (e) {
          alert('Erreur JSON, impossible de basculer');
          return;
        }
        friendlyView.style.display = 'block';
        jsonView.style.display = 'none';
        icon.textContent = 'ğŸ”§';
        text.textContent = 'Mode JSON';
      }
    });

    // Sauvegarder questions
    document.getElementById('saveQuestionsBtn').addEventListener('click', async () => {
      try {
        // Si en mode convivial, on utilise questionsData directement
        // Si en mode JSON, on parse l'Ã©diteur
        let questions;
        if (questionViewMode === 'friendly') {
          questions = questionsData;
        } else {
          const content = document.getElementById('questionsEditor').value;
          questions = JSON.parse(content);
        }

        const result = await apiCall('/api/admin/questions', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ questions })
        });

        if (result.success) {
          showSuccess('Questions sauvegardÃ©es avec succÃ¨s');
          loadQuestions();
        }
      } catch (err) {
        alert('Erreur : JSON invalide ou erreur serveur\n' + err.message);
      }
    });

    // Reset questions
    document.getElementById('resetQuestionsBtn').addEventListener('click', () => {
      if (questionViewMode === 'friendly') {
        loadQuestions(); // Recharger depuis le serveur
      } else {
        document.getElementById('questionsEditor').value = JSON.stringify(questionsData, null, 2);
      }
    });

    // Variables pour mode plantes
    let plantViewMode = 'friendly'; // ou 'json'
    let currentFamily = 'DÃ©polluante';

    // Charger plantes
    async function loadPlants() {
      try {
        plantsData = await apiCall('/api/admin/plants');
        document.getElementById('plantsEditor').value = JSON.stringify(plantsData, null, 2);

        const total = Object.values(plantsData).reduce((sum, arr) => sum + arr.length, 0);
        document.getElementById('plantsCount').textContent = total + ' plantes';

        // Charger la vue conviviale
        renderPlantsList();
      } catch (err) {
        console.error('Erreur chargement plantes:', err);
      }
    }

    // Rendre la liste des plantes en mode convivial
    function renderPlantsList() {
      const container = document.getElementById('plantsListContainer');
      const family = document.getElementById('plantFamilySelect').value;
      const plants = plantsData[family] || [];

      container.innerHTML = '';

      plants.forEach((plant, index) => {
        const card = document.createElement('div');
        card.className = 'card mb-3';
        card.innerHTML = `
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="card-title mb-0">Plante ${index + 1}</h5>
              <button class="btn btn-sm btn-outline-danger" onclick="deletePlant(${index})">ğŸ—‘ï¸ Supprimer</button>
            </div>

            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Nom de la plante</label>
                <input type="text" class="form-control" value="${plant.name}"
                       onchange="updatePlantField('${family}', ${index}, 'name', this.value)">
              </div>
              <div class="col-md-6">
                <label class="form-label">Image de la plante</label>
                <div class="input-group">
                  <input type="text" class="form-control" value="${plant.image}" id="imagePath-${family}-${index}"
                         onchange="updatePlantField('${family}', ${index}, 'image', this.value)">
                  <button class="btn btn-outline-secondary" type="button" onclick="document.getElementById('imageUpload-${family}-${index}').click()">
                    ğŸ“ Parcourir
                  </button>
                  <input type="file" id="imageUpload-${family}-${index}" accept="image/png,image/jpeg,image/jpg"
                         style="display:none" onchange="uploadPlantImage('${family}', ${index}, this)">
                </div>
                <small class="text-muted">Ou saisissez le chemin manuellement</small>
              </div>
              <div class="col-12">
                <label class="form-label">Description</label>
                <textarea class="form-control" rows="2"
                          onchange="updatePlantField('${family}', ${index}, 'description', this.value)">${plant.description}</textarea>
              </div>
              <div class="col-md-6">
                <label class="form-label">ğŸ’§ Arrosage</label>
                <input type="text" class="form-control" value="${plant.care.arrosage}"
                       onchange="updatePlantCare('${family}', ${index}, 'arrosage', this.value)">
              </div>
              <div class="col-md-6">
                <label class="form-label">â˜€ï¸ LumiÃ¨re</label>
                <input type="text" class="form-control" value="${plant.care.lumiere}"
                       onchange="updatePlantCare('${family}', ${index}, 'lumiere', this.value)">
              </div>
              <div class="col-md-6">
                <label class="form-label">ğŸŒ¡ï¸ TempÃ©rature</label>
                <input type="text" class="form-control" value="${plant.care.temperature}"
                       onchange="updatePlantCare('${family}', ${index}, 'temperature', this.value)">
              </div>
              <div class="col-md-6">
                <label class="form-label">ğŸ“Š DifficultÃ©</label>
                <input type="text" class="form-control" value="${plant.care.difficulte}"
                       onchange="updatePlantCare('${family}', ${index}, 'difficulte', this.value)">
              </div>
              <div class="col-12">
                <label class="form-label">âœ¨ Avantages</label>
                <textarea class="form-control" rows="2"
                          onchange="updatePlantField('${family}', ${index}, 'benefits', this.value)">${plant.benefits}</textarea>
              </div>
            </div>
          </div>
        `;
        container.appendChild(card);
      });
    }

    // Mettre Ã  jour un champ de plante
    function updatePlantField(family, index, field, value) {
      plantsData[family][index][field] = value;
      syncJsonEditor();
    }

    // Mettre Ã  jour le soin d'une plante
    function updatePlantCare(family, index, field, value) {
      plantsData[family][index].care[field] = value;
      syncJsonEditor();
    }

    // Supprimer une plante
    function deletePlant(index) {
      const family = document.getElementById('plantFamilySelect').value;
      if (confirm(`ÃŠtes-vous sÃ»r de vouloir supprimer cette plante ?`)) {
        plantsData[family].splice(index, 1);
        renderPlantsList();
        syncJsonEditor();
      }
    }

    // Ajouter une plante
    document.getElementById('addPlantBtn').addEventListener('click', () => {
      const family = document.getElementById('plantFamilySelect').value;
      const newPlant = {
        name: "Nouvelle plante",
        image: "images/plantes/nouvelle.png",
        description: "Description de la plante",
        care: {
          arrosage: "1 fois par semaine",
          lumiere: "LumiÃ¨re indirecte",
          temperature: "18-25Â°C",
          difficulte: "Facile"
        },
        benefits: "Avantages de cette plante"
      };
      plantsData[family].push(newPlant);
      renderPlantsList();
      syncJsonEditor();
    });

    // Synchroniser l'Ã©diteur JSON
    function syncJsonEditor() {
      document.getElementById('plantsEditor').value = JSON.stringify(plantsData, null, 2);
    }

    // Basculer entre mode convivial et JSON
    document.getElementById('togglePlantViewBtn').addEventListener('click', () => {
      const friendlyView = document.getElementById('plantsFriendlyView');
      const jsonView = document.getElementById('plantsJsonView');
      const icon = document.getElementById('viewModeIcon');
      const text = document.getElementById('viewModeText');

      if (plantViewMode === 'friendly') {
        // Basculer vers JSON
        plantViewMode = 'json';
        friendlyView.style.display = 'none';
        jsonView.style.display = 'block';
        icon.textContent = 'ğŸ“';
        text.textContent = 'Mode Simple';
      } else {
        // Basculer vers convivial
        plantViewMode = 'friendly';
        // Recharger depuis JSON (au cas oÃ¹ modifiÃ©)
        try {
          plantsData = JSON.parse(document.getElementById('plantsEditor').value);
          renderPlantsList();
        } catch (e) {
          alert('Erreur JSON, impossible de basculer');
          return;
        }
        friendlyView.style.display = 'block';
        jsonView.style.display = 'none';
        icon.textContent = 'ğŸ”§';
        text.textContent = 'Mode JSON';
      }
    });

    // Changement de famille
    document.getElementById('plantFamilySelect').addEventListener('change', () => {
      renderPlantsList();
    });

    // Upload d'image pour une plante
    async function uploadPlantImage(family, index, input) {
      const file = input.files[0];
      if (!file) return;

      // VÃ©rifier le type de fichier
      if (!file.type.match('image/(png|jpeg|jpg)')) {
        alert('Seuls les fichiers PNG et JPG sont acceptÃ©s');
        return;
      }

      // VÃ©rifier la taille (max 5MB)
      if (file.size > 5 * 1024 * 1024) {
        alert('La taille du fichier ne doit pas dÃ©passer 5MB');
        return;
      }

      try {
        // CrÃ©er FormData pour l'upload
        const formData = new FormData();
        formData.append('image', file);

        // GÃ©nÃ©rer un nom de fichier basÃ© sur le nom de la plante (slug)
        const plantName = plantsData[family][index].name.toLowerCase()
          .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // Enlever accents
          .replace(/[^a-z0-9]+/g, '-') // Remplacer caractÃ¨res spÃ©ciaux par -
          .replace(/^-+|-+$/g, ''); // Enlever - au dÃ©but/fin

        const extension = file.name.split('.').pop();
        const newFileName = `${plantName}.${extension}`;

        // Upload via API (Ã  crÃ©er cÃ´tÃ© serveur)
        const response = await fetch(APP_CONFIG.apiUrl('/api/admin/upload-image'), {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          throw new Error('Erreur lors de l\'upload');
        }

        const result = await response.json();

        // Mettre Ã  jour le chemin de l'image
        const imagePath = `images/plantes/${newFileName}`;
        plantsData[family][index].image = imagePath;
        document.getElementById(`imagePath-${family}-${index}`).value = imagePath;
        syncJsonEditor();

        showSuccess('Image uploadÃ©e avec succÃ¨s');
      } catch (err) {
        alert('Erreur lors de l\'upload de l\'image : ' + err.message);
      }
    }

    // Sauvegarder plantes
    document.getElementById('savePlantsBtn').addEventListener('click', async () => {
      try {
        // Si en mode convivial, on utilise plantsData directement
        // Si en mode JSON, on parse l'Ã©diteur
        let plants;
        if (plantViewMode === 'friendly') {
          plants = plantsData;
        } else {
          const content = document.getElementById('plantsEditor').value;
          plants = JSON.parse(content);
        }

        const result = await apiCall('/api/admin/plants', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ plants })
        });

        if (result.success) {
          showSuccess('Plantes sauvegardÃ©es avec succÃ¨s');
          loadPlants();
        }
      } catch (err) {
        alert('Erreur : JSON invalide ou erreur serveur\n' + err.message);
      }
    });

    // Reset plantes
    document.getElementById('resetPlantsBtn').addEventListener('click', () => {
      if (plantViewMode === 'friendly') {
        loadPlants(); // Recharger depuis le serveur
      } else {
        document.getElementById('plantsEditor').value = JSON.stringify(plantsData, null, 2);
      }
    });

    // GÃ©nÃ©rer donnÃ©es
    document.getElementById('generateSeedBtn').addEventListener('click', async () => {
      const count = parseInt(document.getElementById('seedCount').value);

      if (count < 1 || count > 1000) {
        alert('Nombre invalide (1-1000)');
        return;
      }

      const btn = document.getElementById('generateSeedBtn');
      btn.disabled = true;
      btn.textContent = 'â³ GÃ©nÃ©ration...';

      try {
        const result = await apiCall('/api/admin/seed', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ count })
        });

        document.getElementById('seedResult').innerHTML = `
          <div class="alert alert-success">
            <strong>âœ… ${result.message}</strong>
            <p class="mb-0 mt-2">Vous pouvez maintenant consulter les statistiques mises Ã  jour.</p>
          </div>
        `;

        showSuccess(result.message);
      } catch (err) {
        alert('Erreur lors de la gÃ©nÃ©ration');
        console.error(err);
      } finally {
        btn.disabled = false;
        btn.textContent = 'ğŸ² GÃ©nÃ©rer les donnÃ©es';
      }
    });

    // Initialisation
    loadQuestions();
    loadPlants();
  </script>
</body>
</html>
